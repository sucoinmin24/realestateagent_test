<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ê³µì¸ì¤‘ê°œì‚¬">
    <meta name="theme-color" content="#667eea">
    <title>ê³µì¸ì¤‘ê°œì‚¬ ì‹œí—˜ ë¬¸ì œì§‘</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Malgun Gothic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            -webkit-user-select: none;
            user-select: none;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .progress-bar {
            background: rgba(255,255,255,0.3);
            height: 8px;
            border-radius: 4px;
            margin-top: 15px;
            overflow: hidden;
        }

        .progress-fill {
            background: white;
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .content {
            padding: 40px;
        }

        .start-screen {
            text-align: center;
            padding: 40px 20px;
        }

        .start-screen h2 {
            font-size: 24px;
            color: #333;
            margin-bottom: 20px;
        }

        .start-screen p {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .select-group {
            margin: 25px 0;
            text-align: left;
        }

        .select-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
            font-size: 16px;
        }

        .select-group select,
        .select-group input {
            width: 100%;
            padding: 14px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .select-group select:focus,
        .select-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .select-group input {
            cursor: text;
        }

        #questionCountInput {
            display: none;
            margin-top: 15px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px 45px;
            font-size: 18px;
            border-radius: 30px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 20px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 25px;
        }

        .menu-btn {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 18px 20px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .menu-btn:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        .menu-btn:active {
            transform: translateY(0);
        }

        .menu-icon {
            font-size: 28px;
            flex-shrink: 0;
        }

        .menu-label {
            font-size: 17px;
            font-weight: bold;
            color: #333;
            display: block;
        }

        .menu-desc {
            font-size: 13px;
            color: #888;
            display: block;
            margin-top: 2px;
        }

        .back-btn {
            background: none;
            border: none;
            color: #667eea;
            font-size: 15px;
            cursor: pointer;
            padding: 5px 0;
            margin-bottom: 15px;
            text-align: left;
            display: block;
        }

        .back-btn:active {
            opacity: 0.6;
        }

        .question-screen {
            display: none;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .question-number {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }

        .question-stats {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #666;
        }

        /* ë¬¸ì œ ì´ë¯¸ì§€ ì˜ì—­ */
        .question-image-container {
            margin-bottom: 30px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #e0e0e0;
        }

        .question-image {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 8px;
        }

        .question-image.loading {
            min-height: 400px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ìˆ«ì ë²„íŠ¼ ì˜ì—­ */
        .number-buttons {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .number-btn {
            padding: 20px;
            font-size: 24px;
            font-weight: bold;
            border: 3px solid #e0e0e0;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            -webkit-tap-highlight-color: transparent;
        }

        .number-btn:hover:not(.disabled) {
            border-color: #667eea;
            background: #f8f9ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .number-btn.selected {
            border-color: #667eea;
            background: #f0f4ff;
            color: #667eea;
        }

        .number-btn.correct {
            border-color: #4caf50;
            background: #e8f5e9;
            color: #4caf50;
        }

        .number-btn.wrong {
            border-color: #f44336;
            background: #ffebee;
            color: #f44336;
        }

        .number-btn.disabled {
            pointer-events: none;
            opacity: 0.8;
        }

        .explanation-box {
            margin-top: 25px;
            padding: 20px;
            background: #f0f8ff;
            border-radius: 10px;
            border-left: 4px solid #4caf50;
            display: none;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .explanation-box.show {
            display: block;
        }

        .explanation-title {
            font-weight: bold;
            color: #4caf50;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .explanation-text {
            color: #333;
            line-height: 1.8;
        }

        .explanation-text ul,
        .chat-bubble ul {
            margin: 6px 0 6px 18px;
            padding: 0;
        }

        .explanation-text li,
        .chat-bubble li {
            margin-bottom: 3px;
        }

        .explanation-text strong,
        .chat-bubble strong {
            color: #2c3e50;
        }

        .explanation-text .katex-display,
        .chat-bubble .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding: 4px 0;
            margin: 4px 0;
        }

        .explanation-loading {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #888;
            font-size: 14px;
        }

        .explanation-loading .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid #ddd;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            flex-shrink: 0;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .retry-btn {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 18px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
        }

        .retry-btn:active {
            opacity: 0.7;
        }

        .chat-history {
            margin-top: 12px;
        }

        .chat-bubble {
            padding: 10px 14px;
            border-radius: 10px;
            margin-top: 8px;
            font-size: 14px;
            line-height: 1.6;
        }

        .chat-bubble.user {
            background: #667eea;
            color: white;
            margin-left: 40px;
            text-align: right;
        }

        .chat-bubble.ai {
            background: #e8f5e9;
            color: #333;
            margin-right: 40px;
        }

        .followup-box {
            margin-top: 12px;
        }

        .followup-input-wrap {
            display: flex;
            gap: 8px;
        }

        .followup-input {
            flex: 1;
            padding: 10px 14px;
            border: 2px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
        }

        .followup-input:focus {
            border-color: #667eea;
        }

        .followup-btn {
            padding: 10px 18px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            white-space: nowrap;
        }

        .followup-btn:active {
            opacity: 0.7;
        }

        .followup-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #eee;
            gap: 10px;
        }

        .nav-left, .nav-right {
            display: flex;
            gap: 10px;
        }

        .btn-nav {
            padding: 14px 26px;
            font-size: 16px;
        }

        .btn-secondary {
            background: #95a5a6;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
            box-shadow: 0 5px 15px rgba(149, 165, 166, 0.4);
        }

        .btn-home {
            background: #3498db;
        }

        .btn-home:hover {
            background: #2980b9;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .btn-finish {
            background: #e74c3c;
        }

        .btn-finish:hover {
            background: #c0392b;
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .result-screen {
            display: none;
            text-align: center;
            padding: 40px 20px;
        }

        .score-display {
            font-size: 72px;
            font-weight: bold;
            color: #667eea;
            margin: 30px 0;
        }

        .score-label {
            font-size: 24px;
            color: #333;
            margin-bottom: 10px;
        }

        .score-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 40px 0;
        }

        .score-item {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .score-item-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .score-item-value {
            font-size: 28px;
            font-weight: bold;
            color: #333;
        }

        .wrong-answers {
            margin-top: 40px;
            text-align: left;
        }

        .wrong-answers h3 {
            font-size: 20px;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .wrong-answer-item {
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #ffc107;
        }

        .wrong-answer-header {
            font-weight: bold;
            color: #856404;
            margin-bottom: 10px;
        }

        .wrong-answer-explanation {
            color: #333;
            line-height: 1.6;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ffeaa7;
        }

        .explanation-label {
            font-weight: bold;
            color: #4caf50;
            margin-bottom: 5px;
        }

        .image-error {
            text-align: center;
            padding: 40px;
            color: #f44336;
            background: #ffebee;
            border-radius: 10px;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            body {
                padding: 0;
            }

            .container {
                border-radius: 0;
                min-height: 100vh;
            }

            .content {
                padding: 20px;
            }

            .score-details {
                grid-template-columns: 1fr;
            }

            .score-display {
                font-size: 48px;
            }

            .navigation {
                flex-direction: column;
            }

            .nav-left, .nav-right {
                width: 100%;
            }

            .btn-nav {
                flex: 1;
            }

            .number-buttons {
                grid-template-columns: repeat(5, 1fr);
                gap: 10px;
            }

            .number-btn {
                padding: 15px 10px;
                font-size: 20px;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ  ê³µì¸ì¤‘ê°œì‚¬ ì‹œí—˜ ë¬¸ì œì§‘</h1>
            <p id="headerSubtitle">ê³µì¸ì¤‘ê°œì‚¬ ì‹œí—˜ ëŒ€ë¹„</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <div class="content">
            <!-- ë©”ì¸ ë©”ë‰´ -->
            <div class="start-screen" id="mainMenu">
                <h2>ê³µì¸ì¤‘ê°œì‚¬ ì‹œí—˜ ëŒ€ë¹„ ë¬¸ì œì§‘</h2>
                <p>
                    í•™ìŠµ ìœ í˜•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.
                </p>

                <div class="menu-buttons">
                    <button class="menu-btn" onclick="selectMode('past')">
                        <span class="menu-icon">ğŸ“</span>
                        <span class="menu-label">ê¸°ì¶œ ë¬¸ì œì§‘</span>
                        <span class="menu-desc">ì—°ë„ë³„ ì‹¤ì œ ê¸°ì¶œë¬¸ì œ</span>
                    </button>
                    <button class="menu-btn" onclick="selectMode('mock')">
                        <span class="menu-icon">ğŸ¯</span>
                        <span class="menu-label">ëª¨ì˜ê³ ì‚¬</span>
                        <span class="menu-desc">ì‹¤ì „ ëª¨ì˜ê³ ì‚¬</span>
                    </button>
                    <button class="menu-btn" onclick="selectMode('practice')">
                        <span class="menu-icon">ğŸ“š</span>
                        <span class="menu-label">ì¼ë°˜ ë¬¸ì œì§‘</span>
                        <span class="menu-desc">ì£¼ì œë³„ ì—°ìŠµë¬¸ì œ</span>
                    </button>
                    <button class="menu-btn" onclick="selectMode('all')">
                        <span class="menu-icon">ğŸ”¥</span>
                        <span class="menu-label">ALL</span>
                        <span class="menu-desc">ëª¨ë“  ë¬¸ì œ í†µí•©</span>
                    </button>
                    <button class="menu-btn" onclick="showSettings()" style="border-color: #ddd;">
                        <span class="menu-icon">âš™ï¸</span>
                        <span class="menu-label">API í‚¤ ì„¤ì •</span>
                        <span class="menu-desc" id="apiKeyStatus">AI í•´ì„¤ ê¸°ëŠ¥ì„ ìœ„í•œ API í‚¤ ê´€ë¦¬</span>
                    </button>
                </div>
            </div>

            <!-- API í‚¤ ì„¤ì • í™”ë©´ -->
            <div class="start-screen" id="settingsScreen" style="display:none;">
                <button class="back-btn" onclick="closeSettings()">â† ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°</button>
                <h2>âš™ï¸ API í‚¤ ì„¤ì •</h2>
                <p>AI í•´ì„¤ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ìµœì†Œ 1ê°œì˜ API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.<br>í‚¤ëŠ” ì´ ê¸°ê¸°ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.</p>

                <div class="select-group">
                    <label>ğŸ”µ Gemini API í‚¤ <a href="https://aistudio.google.com/apikey" target="_blank" style="font-size:12px; color:#667eea;">(ë°œê¸‰ë°›ê¸°)</a></label>
                    <input type="password" id="keyGemini" placeholder="AIzaSy..." style="width:100%; padding:12px; border:2px solid #ddd; border-radius:10px; font-size:14px;">
                </div>

                <div class="select-group">
                    <label>ğŸŸ¢ Groq API í‚¤ <a href="https://console.groq.com/keys" target="_blank" style="font-size:12px; color:#667eea;">(ë°œê¸‰ë°›ê¸°)</a></label>
                    <input type="password" id="keyGroq" placeholder="gsk_..." style="width:100%; padding:12px; border:2px solid #ddd; border-radius:10px; font-size:14px;">
                </div>

                <div class="select-group">
                    <label>ğŸŸ¡ OpenRouter API í‚¤ <a href="https://openrouter.ai/keys" target="_blank" style="font-size:12px; color:#667eea;">(ë°œê¸‰ë°›ê¸°)</a></label>
                    <input type="password" id="keyOpenrouter" placeholder="sk-or-..." style="width:100%; padding:12px; border:2px solid #ddd; border-radius:10px; font-size:14px;">
                </div>

                <button class="btn" onclick="saveApiKeys()" style="margin-top:15px;">ğŸ’¾ ì €ì¥</button>
                <button class="btn" onclick="clearApiKeys()" style="margin-top:10px; background: linear-gradient(135deg, #f44336, #e91e63);">ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ</button>
            </div>

            <!-- ì‹œì‘ í™”ë©´ (ëª¨ë“œë³„ ì„¤ì •) -->
            <div class="start-screen" id="startScreen" style="display:none;">
                <button class="back-btn" onclick="goMainMenu()">â† ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°</button>
                <h2 id="startTitle">ê¸°ì¶œ ë¬¸ì œì§‘</h2>
                <p id="startDesc">ê¸°ì¶œë¬¸ì œë¥¼ ë°”íƒ•ìœ¼ë¡œ ë§Œë“¤ì–´ì§„ ë¬¸ì œì§‘ì…ë‹ˆë‹¤.</p>

                <div class="select-group" id="yearSelectGroup">
                    <label for="yearSelect" id="yearLabel">ğŸ“… ë…„ë„ ì„ íƒ:</label>
                    <select id="yearSelect">
                        <option value="all">ì „ì²´ ë…„ë„</option>
                        <option value="2025">2025ë…„ (ì œ36íšŒ)</option>
                        <option value="2024">2024ë…„ (ì œ35íšŒ)</option>
                        <option value="2023">2023ë…„ (ì œ34íšŒ)</option>
                        <option value="2022">2022ë…„ (ì œ33íšŒ)</option>
                        <option value="2021">2021ë…„ (ì œ32íšŒ)</option>
                        <option value="2020">2020ë…„ (ì œ31íšŒ)</option>
                        <option value="random">ğŸ² ëœë¤ (ë§ì¶¤í˜•)</option>
                    </select>
                </div>

                <div class="select-group" id="questionCountInput">
                    <label for="questionCount">ë¬¸í•­ ìˆ˜ ì…ë ¥:</label>
                    <input type="number" id="questionCount" min="5" max="200" value="40" placeholder="ì˜ˆ: 40">
                </div>

                <div class="select-group">
                    <label for="subjectSelect">ğŸ“š ê³¼ëª© ì„ íƒ:</label>
                    <select id="subjectSelect">
                        <option value="all">ì „ì²´ ê³¼ëª© (í†µí•©)</option>
                        <option value="intro">ë¶€ë™ì‚°í•™ê°œë¡ </option>
                        <option value="civil">ë¯¼ë²• ë° ë¯¼ì‚¬íŠ¹ë³„ë²•</option>
                        <option value="broker">ê³µì¸ì¤‘ê°œì‚¬ë²•</option>
                        <option value="public">ë¶€ë™ì‚°ê³µë²•</option>
                        <option value="disclosure">ë¶€ë™ì‚°ê³µì‹œë²• ë° ì„¸ë²•</option>
                    </select>
                </div>

                <button class="btn" onclick="startQuiz()">ì‹œí—˜ ì‹œì‘ ğŸš€</button>
            </div>

            <!-- ë¬¸ì œ í™”ë©´ -->
            <div class="question-screen" id="questionScreen">
                <div class="question-header">
                    <div class="question-number" id="questionNumber">ë¬¸ì œ 1/40</div>
                    <div class="question-stats">
                        <span>â±ï¸ <span id="timer">00:00</span></span>
                        <span id="yearBadge" style="background: #667eea; color: white; padding: 4px 10px; border-radius: 12px; font-size: 13px;"></span>
                        <span id="subjectBadge" style="background: #4caf50; color: white; padding: 4px 10px; border-radius: 12px; font-size: 13px;"></span>
                    </div>
                </div>

                <!-- ë¬¸ì œ ì´ë¯¸ì§€ -->
                <div class="question-image-container">
                    <img id="questionImage" class="question-image" alt="ë¬¸ì œ" />
                </div>

                <!-- ìˆ«ì ë²„íŠ¼ (1-5) -->
                <div class="number-buttons" id="numberButtons">
                    <button class="number-btn" onclick="selectAnswer(0)">1</button>
                    <button class="number-btn" onclick="selectAnswer(1)">2</button>
                    <button class="number-btn" onclick="selectAnswer(2)">3</button>
                    <button class="number-btn" onclick="selectAnswer(3)">4</button>
                    <button class="number-btn" onclick="selectAnswer(4)">5</button>
                </div>

                <!-- í•´ì„¤ -->
                <div class="explanation-box" id="explanationBox">
                    <div class="explanation-title">ğŸ’¡ í•´ì„¤</div>
                    <div class="explanation-text" id="explanationText"></div>
                    <div class="chat-history" id="chatHistory"></div>
                    <div class="followup-box" id="followupBox" style="display:none;">
                        <div class="followup-input-wrap">
                            <input type="text" id="followupInput" class="followup-input" placeholder="ì¶”ê°€ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." />
                            <button class="followup-btn" onclick="sendFollowup()">ì „ì†¡</button>
                        </div>
                    </div>
                </div>

                <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
                <div class="navigation">
                    <div class="nav-left">
                        <button class="btn btn-secondary btn-nav" onclick="previousQuestion()" id="prevBtn">â—€ ì´ì „</button>
                        <button class="btn btn-nav" onclick="nextQuestion()" id="nextBtn">ë‹¤ìŒ â–¶</button>
                    </div>
                    <div class="nav-right">
                        <button class="btn btn-home btn-nav" onclick="goHome()">ğŸ  í™ˆ</button>
                        <button class="btn btn-finish btn-nav" onclick="finishEarly()">â¹ï¸ ì¢…ë£Œ</button>
                    </div>
                </div>
            </div>

            <!-- ê²°ê³¼ í™”ë©´ -->
            <div class="result-screen" id="resultScreen">
                <h2 class="score-label">ìµœì¢… ì ìˆ˜</h2>
                <div class="score-display" id="finalScore">0ì </div>

                <div class="score-details">
                    <div class="score-item">
                        <div class="score-item-label">ì´ ë¬¸ì œ ìˆ˜</div>
                        <div class="score-item-value" id="totalQuestions">0</div>
                    </div>
                    <div class="score-item">
                        <div class="score-item-label">ì •ë‹µ</div>
                        <div class="score-item-value" style="color: #4caf50;" id="correctAnswers">0</div>
                    </div>
                    <div class="score-item">
                        <div class="score-item-label">ì˜¤ë‹µ</div>
                        <div class="score-item-value" style="color: #f44336;" id="wrongAnswers">0</div>
                    </div>
                </div>

                <div class="wrong-answers" id="wrongAnswersSection">
                    <h3>ğŸ“ í‹€ë¦° ë¬¸ì œ í•´ì„¤</h3>
                    <div id="wrongAnswersList"></div>
                </div>

                <button class="btn" onclick="restartQuiz()">ë‹¤ì‹œ ì‹œì‘ ğŸ”„</button>
            </div>
        </div>
    </div>

    <script>
        // ë…„ë„ ì„ íƒ ì‹œ ë¬¸í•­ìˆ˜ ì…ë ¥ í•„ë“œ í‘œì‹œ/ìˆ¨ê¹€
        document.getElementById('yearSelect').addEventListener('change', function() {
            const questionCountInput = document.getElementById('questionCountInput');
            if (this.value === 'random') {
                questionCountInput.style.display = 'block';
            } else {
                questionCountInput.style.display = 'none';
            }
        });

        // ë¬¸ì œ ë°ì´í„°ë² ì´ìŠ¤ (ì´ë¯¸ì§€ ê¸°ë°˜)
        // íŒŒì¼ëª… ê·œì¹™: questions/YYYY_C_T_NN.png
        // YYYY: ë…„ë„ (2025)
        // C: ì°¨ìˆ˜ (1=1ì°¨, 2=2ì°¨)
        // T: êµì‹œ (1=1êµì‹œ, 2=2êµì‹œ)
        // NN: ë¬¸ì œë²ˆí˜¸ (01-40)
        const questionDatabase = [
            // 2025ë…„ 1ì°¨ 1êµì‹œ - ë¶€ë™ì‚°í•™ê°œë¡  (1-40ë²ˆ)
            { year: 2025, subject: 'intro', image: 'questions/2025_1_1_01.png', correct: 0, explanation: 'ë¶€ë™ì„±(fixity)ì€ í† ì§€ê°€ ë¬¼ë¦¬ì ìœ¼ë¡œ ê³ ì •ë˜ì–´ ìˆì–´ ì´ë™í•  ìˆ˜ ì—†ë‹¤ëŠ” íŠ¹ì„±ì„ ë§í•©ë‹ˆë‹¤.' },
            { year: 2025, subject: 'intro', image: 'questions/2025_1_1_02.png', correct: 0, explanation: 'í•œêµ­í‘œì¤€ì‚°ì—…ë¶„ë¥˜(KSIC)ì—ì„œ ë¶€ë™ì‚° ì„ëŒ€ ë° ê³µê¸‰ì—…ì€ ë¶€ë™ì‚°ê´€ë ¨ ì„œë¹„ìŠ¤ì—…ì— í•´ë‹¹í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.' },
            { year: 2025, subject: 'intro', image: 'questions/2025_1_1_03.png', correct: 2, explanation: 'ë‹¤ì¤‘ì£¼íƒì€ ê±´ì¶•ë²•ìƒ ë‹¨ë…ì£¼íƒì˜ í•œ ì¢…ë¥˜ì…ë‹ˆë‹¤.' },
            { year: 2025, subject: 'intro', image: 'questions/2025_1_1_04.png', correct: 2, explanation: ''},
            { year: 2025, subject: 'intro', image: 'questions/2025_1_1_05.png', correct: 3, explanation: 'STPëŠ” Segmentation, Targeting, Positioningì…ë‹ˆë‹¤.'},
            { year: 2025, subject: 'intro', image: 'questions/2025_1_1_06.png', correct: 2, explanation: ''},
            { year: 2025, subject: 'intro', image: 'questions/2025_1_1_07.png', correct: 4, explanation: ''},
            { year: 2025, subject: 'intro', image: 'questions/2025_1_1_08.png', correct: 0, explanation: ''},
            { year: 2025, subject: 'intro', image: 'questions/2025_1_1_09.png', correct: 2, explanation: ''},
            { year: 2025, subject: 'intro', image: 'questions/2025_1_1_10.png', correct: 4, explanation: ''},
            { year: 2025, subject: 'intro', image: 'questions/2025_1_1_11.png', correct: 0, explanation: ''},
            { year: 2025, subject: 'intro', image: 'questions/2025_1_1_12.png', correct: 4, explanation: ''},
            { year: 2025, subject: 'intro', image: 'questions/2025_1_1_13.png', correct: 1, explanation: ''},
            { year: 2025, subject: 'intro', image: 'questions/2025_1_1_14.png', correct: 0, explanation: ''},
            { year: 2025, subject: 'intro', image: 'questions/2025_1_1_15.png', correct: 3, explanation: ''},
            { year: 2025, subject: 'intro', image: 'questions/2025_1_1_16.png', correct: 1, explanation: ''},
            { year: 2025, subject: 'intro', image: 'questions/2025_1_1_17.png', correct: 4, explanation: ''},
            { year: 2025, subject: 'intro', image: 'questions/2025_1_1_18.png', correct: 2, explanation: ''},
            { year: 2025, subject: 'intro', image: 'questions/2025_1_1_19.png', correct: 1, explanation: ''},
            { year: 2025, subject: 'intro', image: 'questions/2025_1_1_20.png', correct: 1, explanation: ''},
            { year: 2025, subject: 'intro', image: 'questions/2025_1_1_21.png', correct: 3, explanation: ''},
            { year: 2025, subject: 'intro', image: 'questions/2025_1_1_22.png', correct: 1, explanation: ''},
            { year: 2025, subject: 'intro', image: 'questions/2025_1_1_23.png', correct: 3, explanation: ''},
            { year: 2025, subject: 'intro', image: 'questions/2025_1_1_24.png', correct: 4, explanation: ''},
            { year: 2025, subject: 'intro', image: 'questions/2025_1_1_25.png', correct: 4, explanation: ''},
            { year: 2025, subject: 'intro', image: 'questions/2025_1_1_26.png', correct: 0, explanation: ''},
            { year: 2025, subject: 'intro', image: 'questions/2025_1_1_27.png', correct: 2, explanation: ''},
            { year: 2025, subject: 'intro', image: 'questions/2025_1_1_28.png', correct: 3, explanation: ''},
            { year: 2025, subject: 'intro', image: 'questions/2025_1_1_29.png', correct: 1, explanation: ''},
            { year: 2025, subject: 'intro', image: 'questions/2025_1_1_30.png', correct: 2, explanation: ''},
            { year: 2025, subject: 'intro', image: 'questions/2025_1_1_31.png', correct: 1, explanation: ''},
            { year: 2025, subject: 'intro', image: 'questions/2025_1_1_32.png', correct: 2, explanation: ''},
            { year: 2025, subject: 'intro', image: 'questions/2025_1_1_33.png', correct: 4, explanation: ''},
            { year: 2025, subject: 'intro', image: 'questions/2025_1_1_34.png', correct: 0, explanation: ''},
            { year: 2025, subject: 'intro', image: 'questions/2025_1_1_35.png', correct: 1, explanation: ''},
            { year: 2025, subject: 'intro', image: 'questions/2025_1_1_36.png', correct: 4, explanation: ''},
            { year: 2025, subject: 'intro', image: 'questions/2025_1_1_37.png', correct: 3, explanation: ''},
            { year: 2025, subject: 'intro', image: 'questions/2025_1_1_38.png', correct: 3, explanation: ''},
            { year: 2025, subject: 'intro', image: 'questions/2025_1_1_39.png', correct: 2, explanation: ''},
            { year: 2025, subject: 'intro', image: 'questions/2025_1_1_40.png', correct: 0, explanation: ''},
            
            // 2025ë…„ 1ì°¨ 1êµì‹œ - ë¯¼ë²• (41-80ë²ˆ)
            { year: 2025, subject: 'civil', image: 'questions/2025_1_1_41.png', correct: 1, explanation: ''},
            { year: 2025, subject: 'civil', image: 'questions/2025_1_1_42.png', correct: 2, explanation: ''},
            { year: 2025, subject: 'civil', image: 'questions/2025_1_1_43.png', correct: 0, explanation: ''},
            { year: 2025, subject: 'civil', image: 'questions/2025_1_1_44.png', correct: 4, explanation: ''},
            { year: 2025, subject: 'civil', image: 'questions/2025_1_1_45.png', correct: 3, explanation: ''},
            { year: 2025, subject: 'civil', image: 'questions/2025_1_1_46.png', correct: 0, explanation: ''},
            { year: 2025, subject: 'civil', image: 'questions/2025_1_1_47.png', correct: 1, explanation: ''},
            { year: 2025, subject: 'civil', image: 'questions/2025_1_1_48.png', correct: 2, explanation: ''},
            { year: 2025, subject: 'civil', image: 'questions/2025_1_1_49.png', correct: 3, explanation: ''},
            { year: 2025, subject: 'civil', image: 'questions/2025_1_1_50.png', correct: 2, explanation: ''},
            { year: 2025, subject: 'civil', image: 'questions/2025_1_1_51.png', correct: 3, explanation: ''},
            { year: 2025, subject: 'civil', image: 'questions/2025_1_1_52.png', correct: 1, explanation: ''},
            { year: 2025, subject: 'civil', image: 'questions/2025_1_1_53.png', correct: 0, explanation: ''},
            { year: 2025, subject: 'civil', image: 'questions/2025_1_1_54.png', correct: 4, explanation: ''},
            { year: 2025, subject: 'civil', image: 'questions/2025_1_1_55.png', correct: 3, explanation: ''},
            { year: 2025, subject: 'civil', image: 'questions/2025_1_1_56.png', correct: 3, explanation: ''},
            { year: 2025, subject: 'civil', image: 'questions/2025_1_1_57.png', correct: 2, explanation: ''},
            { year: 2025, subject: 'civil', image: 'questions/2025_1_1_58.png', correct: 0, explanation: ''},
            { year: 2025, subject: 'civil', image: 'questions/2025_1_1_59.png', correct: 1, explanation: ''},
            { year: 2025, subject: 'civil', image: 'questions/2025_1_1_60.png', correct: 4, explanation: ''},
            { year: 2025, subject: 'civil', image: 'questions/2025_1_1_61.png', correct: 3, explanation: ''},
            { year: 2025, subject: 'civil', image: 'questions/2025_1_1_62.png', correct: 3, explanation: ''},
            { year: 2025, subject: 'civil', image: 'questions/2025_1_1_63.png', correct: 1, explanation: ''},
            { year: 2025, subject: 'civil', image: 'questions/2025_1_1_64.png', correct: 4, explanation: ''},
            { year: 2025, subject: 'civil', image: 'questions/2025_1_1_65.png', correct: 0, explanation: ''},
            { year: 2025, subject: 'civil', image: 'questions/2025_1_1_66.png', correct: 2, explanation: ''},
            { year: 2025, subject: 'civil', image: 'questions/2025_1_1_67.png', correct: 4, explanation: ''},
            { year: 2025, subject: 'civil', image: 'questions/2025_1_1_68.png', correct: 3, explanation: ''},
            { year: 2025, subject: 'civil', image: 'questions/2025_1_1_69.png', correct: 0, explanation: ''},
            { year: 2025, subject: 'civil', image: 'questions/2025_1_1_70.png', correct: 3, explanation: ''},
            { year: 2025, subject: 'civil', image: 'questions/2025_1_1_71.png', correct: 4, explanation: ''},
            { year: 2025, subject: 'civil', image: 'questions/2025_1_1_72.png', correct: 2, explanation: ''},
            { year: 2025, subject: 'civil', image: 'questions/2025_1_1_73.png', correct: 1, explanation: ''},
            { year: 2025, subject: 'civil', image: 'questions/2025_1_1_74.png', correct: 1, explanation: ''},
            { year: 2025, subject: 'civil', image: 'questions/2025_1_1_75.png', correct: 4, explanation: ''},
            { year: 2025, subject: 'civil', image: 'questions/2025_1_1_76.png', correct: 1, explanation: ''},
            { year: 2025, subject: 'civil', image: 'questions/2025_1_1_77.png', correct: 2, explanation: ''},
            { year: 2025, subject: 'civil', image: 'questions/2025_1_1_78.png', correct: 4, explanation: ''},
            { year: 2025, subject: 'civil', image: 'questions/2025_1_1_79.png', correct: 0, explanation: ''},
            { year: 2025, subject: 'civil', image: 'questions/2025_1_1_80.png', correct: 2, explanation: ''},
            
            // 2025ë…„ 2ì°¨ 1êµì‹œ - ê³µì¸ì¤‘ê°œì‚¬ë²• (1-40ë²ˆ)
            { year: 2025, subject: 'broker', image: 'questions/2025_2_1_01.png', correct: 4, explanation: 'ê³µì¸ì¤‘ê°œì‚¬ë²• ì„¤ëª…' },
            { year: 2025, subject: 'broker', image: 'questions/2025_2_1_02.png', correct: 1, explanation: 'ê³µì¸ì¤‘ê°œì‚¬ ìê²©ì¦ ê´€ë ¨' },
            
            // 2025ë…„ 2ì°¨ 1êµì‹œ - ë¶€ë™ì‚°ê³µë²• (41-80ë²ˆ)
            { year: 2025, subject: 'public', image: 'questions/2025_2_1_41.png', correct: 2, explanation: 'êµ­í† ê³„íšë²• ê´€ë ¨' },
            
            // 2025ë…„ 2ì°¨ 2êµì‹œ - ë¶€ë™ì‚°ê³µì‹œë²• ë° ì„¸ë²• (1-40ë²ˆ)
            { year: 2025, subject: 'disclosure', image: 'questions/2025_2_2_01.png', correct: 0, explanation: 'ê³µê°„ì •ë³´ë²• ì„¤ëª…' },

            // 2024ë…„ 1ì°¨ 1êµì‹œ - ë¶€ë™ì‚°í•™ê°œë¡  (1-40ë²ˆ)
            { year: 2024, subject: 'intro', image: 'questions/2024_1_1_01.png', correct: 3, explanation: ''},
            { year: 2024, subject: 'intro', image: 'questions/2024_1_1_02.png', correct: 1, explanation: ''},
            { year: 2024, subject: 'intro', image: 'questions/2024_1_1_03.png', correct: 3, explanation: ''},
            { year: 2024, subject: 'intro', image: 'questions/2024_1_1_04.png', correct: 0, explanation: ''},
            { year: 2024, subject: 'intro', image: 'questions/2024_1_1_05.png', correct: 4, explanation: ''},
            { year: 2024, subject: 'intro', image: 'questions/2024_1_1_06.png', correct: 4, explanation: ''},
            { year: 2024, subject: 'intro', image: 'questions/2024_1_1_07.png', correct: 1, explanation: ''},
            { year: 2024, subject: 'intro', image: 'questions/2024_1_1_08.png', correct: 3, explanation: ''},
            { year: 2024, subject: 'intro', image: 'questions/2024_1_1_09.png', correct: 0, explanation: ''},
            { year: 2024, subject: 'intro', image: 'questions/2024_1_1_10.png', correct: 2, explanation: ''},
            { year: 2024, subject: 'intro', image: 'questions/2024_1_1_11.png', correct: 1, explanation: ''},
            { year: 2024, subject: 'intro', image: 'questions/2024_1_1_12.png', correct: 0, explanation: ''},
            { year: 2024, subject: 'intro', image: 'questions/2024_1_1_13.png', correct: 4, explanation: ''},
            { year: 2024, subject: 'intro', image: 'questions/2024_1_1_14.png', correct: 3, explanation: ''},
            { year: 2024, subject: 'intro', image: 'questions/2024_1_1_15.png', correct: 1, explanation: ''},
            { year: 2024, subject: 'intro', image: 'questions/2024_1_1_16.png', correct: 2, explanation: ''},
            { year: 2024, subject: 'intro', image: 'questions/2024_1_1_17.png', correct: 2, explanation: ''},
            { year: 2024, subject: 'intro', image: 'questions/2024_1_1_18.png', correct: 0, explanation: ''},
            { year: 2024, subject: 'intro', image: 'questions/2024_1_1_19.png', correct: 4, explanation: ''},
            { year: 2024, subject: 'intro', image: 'questions/2024_1_1_20.png', correct: 4, explanation: ''},
            { year: 2024, subject: 'intro', image: 'questions/2024_1_1_21.png', correct: 3, explanation: ''},
            { year: 2024, subject: 'intro', image: 'questions/2024_1_1_22.png', correct: 0, explanation: ''},
            { year: 2024, subject: 'intro', image: 'questions/2024_1_1_23.png', correct: 3, explanation: ''},
            { year: 2024, subject: 'intro', image: 'questions/2024_1_1_24.png', correct: 2, explanation: ''},
            { year: 2024, subject: 'intro', image: 'questions/2024_1_1_25.png', correct: 4, explanation: ''},
            { year: 2024, subject: 'intro', image: 'questions/2024_1_1_26.png', correct: 3, explanation: ''},
            { year: 2024, subject: 'intro', image: 'questions/2024_1_1_27.png', correct: 2, explanation: ''},
            { year: 2024, subject: 'intro', image: 'questions/2024_1_1_28.png', correct: 1, explanation: ''},
            { year: 2024, subject: 'intro', image: 'questions/2024_1_1_29.png', correct: 2, explanation: ''},
            { year: 2024, subject: 'intro', image: 'questions/2024_1_1_30.png', correct: 1, explanation: ''},
            { year: 2024, subject: 'intro', image: 'questions/2024_1_1_31.png', correct: 3, explanation: ''},
            { year: 2024, subject: 'intro', image: 'questions/2024_1_1_32.png', correct: 1, explanation: ''},
            { year: 2024, subject: 'intro', image: 'questions/2024_1_1_33.png', correct: 2, explanation: ''},
            { year: 2024, subject: 'intro', image: 'questions/2024_1_1_34.png', correct: 4, explanation: ''},
            { year: 2024, subject: 'intro', image: 'questions/2024_1_1_35.png', correct: 0, explanation: ''},
            { year: 2024, subject: 'intro', image: 'questions/2024_1_1_36.png', correct: 0, explanation: ''},
            { year: 2024, subject: 'intro', image: 'questions/2024_1_1_37.png', correct: 1, explanation: ''},
            { year: 2024, subject: 'intro', image: 'questions/2024_1_1_38.png', correct: 2, explanation: ''},
            { year: 2024, subject: 'intro', image: 'questions/2024_1_1_39.png', correct: 4, explanation: ''},
            { year: 2024, subject: 'intro', image: 'questions/2024_1_1_40.png', correct: 0, explanation: ''},
            
            // 2024ë…„ 1ì°¨ 1êµì‹œ - ë¯¼ë²• (41-80ë²ˆ)
            { year: 2024, subject: 'civil', image: 'questions/2024_1_1_41.png', correct: 2, explanation: ''},
            { year: 2024, subject: 'civil', image: 'questions/2024_1_1_42.png', correct: 4, explanation: ''},
            { year: 2024, subject: 'civil', image: 'questions/2024_1_1_43.png', correct: 2, explanation: ''},
            { year: 2024, subject: 'civil', image: 'questions/2024_1_1_44.png', correct: 2, explanation: ''},
            { year: 2024, subject: 'civil', image: 'questions/2024_1_1_45.png', correct: 1, explanation: ''},
            { year: 2024, subject: 'civil', image: 'questions/2024_1_1_46.png', correct: 4, explanation: ''},
            { year: 2024, subject: 'civil', image: 'questions/2024_1_1_47.png', correct: 4, explanation: ''},
            { year: 2024, subject: 'civil', image: 'questions/2024_1_1_48.png', correct: 0, explanation: ''},
            { year: 2024, subject: 'civil', image: 'questions/2024_1_1_49.png', correct: 0, explanation: ''},
            { year: 2024, subject: 'civil', image: 'questions/2024_1_1_50.png', correct: 1, explanation: ''},
            { year: 2024, subject: 'civil', image: 'questions/2024_1_1_51.png', correct: 3, explanation: ''},
            { year: 2024, subject: 'civil', image: 'questions/2024_1_1_52.png', correct: 2, explanation: ''},
            { year: 2024, subject: 'civil', image: 'questions/2024_1_1_53.png', correct: 4, explanation: ''},
            { year: 2024, subject: 'civil', image: 'questions/2024_1_1_54.png', correct: 1, explanation: ''},
            { year: 2024, subject: 'civil', image: 'questions/2024_1_1_55.png', correct: 3, explanation: ''},
            { year: 2024, subject: 'civil', image: 'questions/2024_1_1_56.png', correct: 4, explanation: ''},
            { year: 2024, subject: 'civil', image: 'questions/2024_1_1_57.png', correct: 0, explanation: ''},
            { year: 2024, subject: 'civil', image: 'questions/2024_1_1_58.png', correct: 1, explanation: ''},
            { year: 2024, subject: 'civil', image: 'questions/2024_1_1_59.png', correct: 1, explanation: ''},
            { year: 2024, subject: 'civil', image: 'questions/2024_1_1_60.png', correct: 0, explanation: ''},
            { year: 2024, subject: 'civil', image: 'questions/2024_1_1_61.png', correct: 3, explanation: ''},
            { year: 2024, subject: 'civil', image: 'questions/2024_1_1_62.png', correct: 3, explanation: ''},
            { year: 2024, subject: 'civil', image: 'questions/2024_1_1_63.png', correct: 1, explanation: ''},
            { year: 2024, subject: 'civil', image: 'questions/2024_1_1_64.png', correct: 2, explanation: ''},
            { year: 2024, subject: 'civil', image: 'questions/2024_1_1_65.png', correct: 4, explanation: ''},
            { year: 2024, subject: 'civil', image: 'questions/2024_1_1_66.png', correct: 4, explanation: ''},
            { year: 2024, subject: 'civil', image: 'questions/2024_1_1_67.png', correct: 0, explanation: ''},
            { year: 2024, subject: 'civil', image: 'questions/2024_1_1_68.png', correct: 4, explanation: ''},
            { year: 2024, subject: 'civil', image: 'questions/2024_1_1_69.png', correct: 0, explanation: ''},
            { year: 2024, subject: 'civil', image: 'questions/2024_1_1_70.png', correct: 4, explanation: ''},
            { year: 2024, subject: 'civil', image: 'questions/2024_1_1_71.png', correct: 0, explanation: ''},
            { year: 2024, subject: 'civil', image: 'questions/2024_1_1_72.png', correct: 3, explanation: ''},
            { year: 2024, subject: 'civil', image: 'questions/2024_1_1_73.png', correct: 2, explanation: ''},
            { year: 2024, subject: 'civil', image: 'questions/2024_1_1_74.png', correct: 2, explanation: ''},
            { year: 2024, subject: 'civil', image: 'questions/2024_1_1_75.png', correct: 2, explanation: ''},
            { year: 2024, subject: 'civil', image: 'questions/2024_1_1_76.png', correct: 0, explanation: ''},
            { year: 2024, subject: 'civil', image: 'questions/2024_1_1_77.png', correct: 0, explanation: ''},
            { year: 2024, subject: 'civil', image: 'questions/2024_1_1_78.png', correct: 0, explanation: ''},
            { year: 2024, subject: 'civil', image: 'questions/2024_1_1_79.png', correct: 1, explanation: ''},
            { year: 2024, subject: 'civil', image: 'questions/2024_1_1_80.png', correct: 3, explanation: ''},

            // 2023ë…„ 1ì°¨ 1êµì‹œ - ë¶€ë™ì‚°í•™ê°œë¡  (1-40ë²ˆ)
            { year: 2023, subject: 'intro', image: 'questions/2023_1_1_01.png', correct: 0, explanation: ''},
            { year: 2023, subject: 'intro', image: 'questions/2023_1_1_02.png', correct: 2, explanation: ''},
            { year: 2023, subject: 'intro', image: 'questions/2023_1_1_03.png', correct: 3, explanation: ''},
            { year: 2023, subject: 'intro', image: 'questions/2023_1_1_04.png', correct: 1, explanation: ''},
            { year: 2023, subject: 'intro', image: 'questions/2023_1_1_05.png', correct: 2, explanation: ''},
            { year: 2023, subject: 'intro', image: 'questions/2023_1_1_06.png', correct: 3, explanation: ''},
            { year: 2023, subject: 'intro', image: 'questions/2023_1_1_07.png', correct: 4, explanation: ''},
            { year: 2023, subject: 'intro', image: 'questions/2023_1_1_08.png', correct: 3, explanation: ''},
            { year: 2023, subject: 'intro', image: 'questions/2023_1_1_09.png', correct: 1, explanation: ''},
            { year: 2023, subject: 'intro', image: 'questions/2023_1_1_10.png', correct: 0, explanation: ''},
            { year: 2023, subject: 'intro', image: 'questions/2023_1_1_11.png', correct: 1, explanation: ''},
            { year: 2023, subject: 'intro', image: 'questions/2023_1_1_12.png', correct: 2, explanation: ''},
            { year: 2023, subject: 'intro', image: 'questions/2023_1_1_13.png', correct: 1, explanation: ''},
            { year: 2023, subject: 'intro', image: 'questions/2023_1_1_14.png', correct: 2, explanation: ''},
            { year: 2023, subject: 'intro', image: 'questions/2023_1_1_15.png', correct: 0, explanation: '1,2,3,4,5ë²ˆ ëª¨ë‘ ì •ë‹µ'},
            { year: 2023, subject: 'intro', image: 'questions/2023_1_1_16.png', correct: 1, explanation: ''},
            { year: 2023, subject: 'intro', image: 'questions/2023_1_1_17.png', correct: 3, explanation: ''},
            { year: 2023, subject: 'intro', image: 'questions/2023_1_1_18.png', correct: 2, explanation: ''},
            { year: 2023, subject: 'intro', image: 'questions/2023_1_1_19.png', correct: 2, explanation: ''},
            { year: 2023, subject: 'intro', image: 'questions/2023_1_1_20.png', correct: 4, explanation: ''},
            { year: 2023, subject: 'intro', image: 'questions/2023_1_1_21.png', correct: 3, explanation: ''},
            { year: 2023, subject: 'intro', image: 'questions/2023_1_1_22.png', correct: 0, explanation: ''},
            { year: 2023, subject: 'intro', image: 'questions/2023_1_1_23.png', correct: 1, explanation: ''},
            { year: 2023, subject: 'intro', image: 'questions/2023_1_1_24.png', correct: 0, explanation: ''},
            { year: 2023, subject: 'intro', image: 'questions/2023_1_1_25.png', correct: 2, explanation: ''},
            { year: 2023, subject: 'intro', image: 'questions/2023_1_1_26.png', correct: 0, explanation: ''},
            { year: 2023, subject: 'intro', image: 'questions/2023_1_1_27.png', correct: 0, explanation: '1,2,3,4,5ë²ˆ ëª¨ë‘ ì •ë‹µ'},
            { year: 2023, subject: 'intro', image: 'questions/2023_1_1_28.png', correct: 0, explanation: ''},
            { year: 2023, subject: 'intro', image: 'questions/2023_1_1_29.png', correct: 3, explanation: ''},
            { year: 2023, subject: 'intro', image: 'questions/2023_1_1_30.png', correct: 4, explanation: ''},
            { year: 2023, subject: 'intro', image: 'questions/2023_1_1_31.png', correct: 1, explanation: ''},
            { year: 2023, subject: 'intro', image: 'questions/2023_1_1_32.png', correct: 4, explanation: ''},
            { year: 2023, subject: 'intro', image: 'questions/2023_1_1_33.png', correct: 4, explanation: ''},
            { year: 2023, subject: 'intro', image: 'questions/2023_1_1_34.png', correct: 3, explanation: ''},
            { year: 2023, subject: 'intro', image: 'questions/2023_1_1_35.png', correct: 3, explanation: ''},
            { year: 2023, subject: 'intro', image: 'questions/2023_1_1_36.png', correct: 4, explanation: ''},
            { year: 2023, subject: 'intro', image: 'questions/2023_1_1_37.png', correct: 4, explanation: ''},
            { year: 2023, subject: 'intro', image: 'questions/2023_1_1_38.png', correct: 0, explanation: ''},
            { year: 2023, subject: 'intro', image: 'questions/2023_1_1_39.png', correct: 1, explanation: ''},
            { year: 2023, subject: 'intro', image: 'questions/2023_1_1_40.png', correct: 0, explanation: ''},
            
            // 2023ë…„ 1ì°¨ 1êµì‹œ - ë¯¼ë²• (41-80ë²ˆ)
            { year: 2023, subject: 'civil', image: 'questions/2023_1_1_41.png', correct: 0, explanation: ''},
            { year: 2023, subject: 'civil', image: 'questions/2023_1_1_42.png', correct: 4, explanation: ''},
            { year: 2023, subject: 'civil', image: 'questions/2023_1_1_43.png', correct: 0, explanation: ''},
            { year: 2023, subject: 'civil', image: 'questions/2023_1_1_44.png', correct: 3, explanation: ''},
            { year: 2023, subject: 'civil', image: 'questions/2023_1_1_45.png', correct: 2, explanation: ''},
            { year: 2023, subject: 'civil', image: 'questions/2023_1_1_46.png', correct: 0, explanation: ''},
            { year: 2023, subject: 'civil', image: 'questions/2023_1_1_47.png', correct: 3, explanation: ''},
            { year: 2023, subject: 'civil', image: 'questions/2023_1_1_48.png', correct: 1, explanation: ''},
            { year: 2023, subject: 'civil', image: 'questions/2023_1_1_49.png', correct: 0, explanation: ''},
            { year: 2023, subject: 'civil', image: 'questions/2023_1_1_50.png', correct: 4, explanation: ''},
            { year: 2023, subject: 'civil', image: 'questions/2023_1_1_51.png', correct: 1, explanation: ''},
            { year: 2023, subject: 'civil', image: 'questions/2023_1_1_52.png', correct: 2, explanation: ''},
            { year: 2023, subject: 'civil', image: 'questions/2023_1_1_53.png', correct: 2, explanation: ''},
            { year: 2023, subject: 'civil', image: 'questions/2023_1_1_54.png', correct: 0, explanation: ''},
            { year: 2023, subject: 'civil', image: 'questions/2023_1_1_55.png', correct: 1, explanation: ''},
            { year: 2023, subject: 'civil', image: 'questions/2023_1_1_56.png', correct: 3, explanation: ''},
            { year: 2023, subject: 'civil', image: 'questions/2023_1_1_57.png', correct: 2, explanation: ''},
            { year: 2023, subject: 'civil', image: 'questions/2023_1_1_58.png', correct: 1, explanation: ''},
            { year: 2023, subject: 'civil', image: 'questions/2023_1_1_59.png', correct: 4, explanation: ''},
            { year: 2023, subject: 'civil', image: 'questions/2023_1_1_60.png', correct: 3, explanation: ''},
            { year: 2023, subject: 'civil', image: 'questions/2023_1_1_61.png', correct: 4, explanation: ''},
            { year: 2023, subject: 'civil', image: 'questions/2023_1_1_62.png', correct: 3, explanation: ''},
            { year: 2023, subject: 'civil', image: 'questions/2023_1_1_63.png', correct: 1, explanation: ''},
            { year: 2023, subject: 'civil', image: 'questions/2023_1_1_64.png', correct: 3, explanation: ''},
            { year: 2023, subject: 'civil', image: 'questions/2023_1_1_65.png', correct: 0, explanation: ''},
            { year: 2023, subject: 'civil', image: 'questions/2023_1_1_66.png', correct: 2, explanation: ''},
            { year: 2023, subject: 'civil', image: 'questions/2023_1_1_67.png', correct: 2, explanation: ''},
            { year: 2023, subject: 'civil', image: 'questions/2023_1_1_68.png', correct: 4, explanation: ''},
            { year: 2023, subject: 'civil', image: 'questions/2023_1_1_69.png', correct: 1, explanation: ''},
            { year: 2023, subject: 'civil', image: 'questions/2023_1_1_70.png', correct: 3, explanation: ''},
            { year: 2023, subject: 'civil', image: 'questions/2023_1_1_71.png', correct: 4, explanation: ''},
            { year: 2023, subject: 'civil', image: 'questions/2023_1_1_72.png', correct: 3, explanation: ''},
            { year: 2023, subject: 'civil', image: 'questions/2023_1_1_73.png', correct: 2, explanation: ''},
            { year: 2023, subject: 'civil', image: 'questions/2023_1_1_74.png', correct: 4, explanation: ''},
            { year: 2023, subject: 'civil', image: 'questions/2023_1_1_75.png', correct: 4, explanation: ''},
            { year: 2023, subject: 'civil', image: 'questions/2023_1_1_76.png', correct: 2, explanation: ''},
            { year: 2023, subject: 'civil', image: 'questions/2023_1_1_77.png', correct: 0, explanation: ''},
            { year: 2023, subject: 'civil', image: 'questions/2023_1_1_78.png', correct: 1, explanation: ''},
            { year: 2023, subject: 'civil', image: 'questions/2023_1_1_79.png', correct: 0, explanation: ''},
            { year: 2023, subject: 'civil', image: 'questions/2023_1_1_80.png', correct: 1, explanation: ''},
        ];

        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let questionAnswered = [];
        let startTime;
        let timerInterval;
        let currentMode = 'past'; // past, mock, practice, all

        // ëª¨ì˜ê³ ì‚¬ ë¬¸ì œ DB (ë‚˜ì¤‘ì— ì¶”ê°€)
        const mockDatabase = [];

        // ì¼ë°˜ ë¬¸ì œì§‘ DB (ë‚˜ì¤‘ì— ì¶”ê°€)
        const practiceDatabase = [];

        // ëª¨ë“œ ì„ íƒ
        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('startScreen').style.display = 'block';

            const yearGroup = document.getElementById('yearSelectGroup');
            const yearLabel = document.getElementById('yearLabel');
            const startTitle = document.getElementById('startTitle');
            const startDesc = document.getElementById('startDesc');

            if (mode === 'past') {
                startTitle.textContent = 'ğŸ“ ê¸°ì¶œ ë¬¸ì œì§‘';
                startDesc.innerHTML = 'ì—°ë„ë³„ ì‹¤ì œ ê¸°ì¶œë¬¸ì œì…ë‹ˆë‹¤.<br>2023, 2024, 2025ë…„ ë°˜ì˜ ì™„ë£Œ.';
                yearGroup.style.display = 'block';
                yearLabel.textContent = 'ğŸ“… ë…„ë„ ì„ íƒ:';
                document.getElementById('yearSelect').innerHTML = `
                    <option value="all">ì „ì²´ ë…„ë„</option>
                    <option value="2025">2025ë…„ (ì œ36íšŒ)</option>
                    <option value="2024">2024ë…„ (ì œ35íšŒ)</option>
                    <option value="2023">2023ë…„ (ì œ34íšŒ)</option>
                    <option value="2022">2022ë…„ (ì œ33íšŒ)</option>
                    <option value="2021">2021ë…„ (ì œ32íšŒ)</option>
                    <option value="2020">2020ë…„ (ì œ31íšŒ)</option>
                    <option value="random">ğŸ² ëœë¤ (ë§ì¶¤í˜•)</option>
                `;
                document.getElementById('headerSubtitle').textContent = 'ê¸°ì¶œ ë¬¸ì œì§‘';
            } else if (mode === 'mock') {
                startTitle.textContent = 'ğŸ¯ ëª¨ì˜ê³ ì‚¬';
                startDesc.innerHTML = 'ì‹¤ì „ì²˜ëŸ¼ í’€ì–´ë³´ëŠ” ëª¨ì˜ê³ ì‚¬ì…ë‹ˆë‹¤.';
                yearGroup.style.display = 'block';
                yearLabel.textContent = 'ğŸ“‹ ëª¨ì˜ê³ ì‚¬:';
                document.getElementById('yearSelect').innerHTML = `
                    <option value="all">ì „ì²´</option>
                    <option value="random">ğŸ² ëœë¤ (ë§ì¶¤í˜•)</option>
                `;
                document.getElementById('headerSubtitle').textContent = 'ëª¨ì˜ê³ ì‚¬';
            } else if (mode === 'practice') {
                startTitle.textContent = 'ğŸ“š ì¼ë°˜ ë¬¸ì œì§‘';
                startDesc.innerHTML = 'ì£¼ì œë³„ ì—°ìŠµë¬¸ì œì…ë‹ˆë‹¤.';
                yearGroup.style.display = 'block';
                yearLabel.textContent = 'ğŸ“‹ ë¬¸ì œì§‘:';
                document.getElementById('yearSelect').innerHTML = `
                    <option value="all">ì „ì²´</option>
                    <option value="random">ğŸ² ëœë¤ (ë§ì¶¤í˜•)</option>
                `;
                document.getElementById('headerSubtitle').textContent = 'ì¼ë°˜ ë¬¸ì œì§‘';
            } else if (mode === 'all') {
                startTitle.textContent = 'ğŸ”¥ ALL';
                startDesc.innerHTML = 'ê¸°ì¶œ + ëª¨ì˜ê³ ì‚¬ + ì¼ë°˜ ë¬¸ì œ ëª¨ë‘ í¬í•¨.';
                yearGroup.style.display = 'block';
                yearLabel.textContent = 'ğŸ“‹ ë¬¸ì œì§‘:';

                // ëª¨ë“  DBì—ì„œ ì˜µì…˜ ë™ì  ìƒì„±
                let options = '<option value="all">ì „ì²´</option>';

                // ê¸°ì¶œ ë…„ë„ ì¶”ì¶œ
                const pastYears = [...new Set(questionDatabase.map(q => q.year))].sort((a, b) => b - a);
                if (pastYears.length > 0) {
                    options += '<optgroup label="ğŸ“ ê¸°ì¶œ ë¬¸ì œì§‘">';
                    const examNames = { 2025: 'ì œ36íšŒ', 2024: 'ì œ35íšŒ', 2023: 'ì œ34íšŒ', 2022: 'ì œ33íšŒ', 2021: 'ì œ32íšŒ', 2020: 'ì œ31íšŒ' };
                    pastYears.forEach(y => {
                        options += `<option value="past_${y}">${y}ë…„ ê¸°ì¶œ${examNames[y] ? ' (' + examNames[y] + ')' : ''}</option>`;
                    });
                    options += '</optgroup>';
                }

                // ëª¨ì˜ê³ ì‚¬ í•­ëª© ì¶”ì¶œ
                const mockItems = [...new Set(mockDatabase.map(q => q.year))].sort((a, b) => b - a);
                if (mockItems.length > 0) {
                    options += '<optgroup label="ğŸ¯ ëª¨ì˜ê³ ì‚¬">';
                    mockItems.forEach(y => {
                        options += `<option value="mock_${y}">ëª¨ì˜ê³ ì‚¬ ${y}</option>`;
                    });
                    options += '</optgroup>';
                }

                // ì¼ë°˜ ë¬¸ì œì§‘ í•­ëª© ì¶”ì¶œ
                const practiceItems = [...new Set(practiceDatabase.map(q => q.year))].sort((a, b) => b - a);
                if (practiceItems.length > 0) {
                    options += '<optgroup label="ğŸ“š ì¼ë°˜ ë¬¸ì œì§‘">';
                    practiceItems.forEach(y => {
                        options += `<option value="practice_${y}">ë¬¸ì œì§‘ ${y}</option>`;
                    });
                    options += '</optgroup>';
                }

                options += '<option value="random">ğŸ² ëœë¤ (ë§ì¶¤í˜•)</option>';
                document.getElementById('yearSelect').innerHTML = options;
                document.getElementById('headerSubtitle').textContent = 'ALL';
            }
        }

        // ë©”ì¸ ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°
        function goMainMenu() {
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('mainMenu').style.display = 'block';
            document.getElementById('headerSubtitle').textContent = 'ê³µì¸ì¤‘ê°œì‚¬ ì‹œí—˜ ëŒ€ë¹„';
            updateApiKeyStatus();
        }

        // ì„¤ì • í™”ë©´
        function showSettings() {
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('settingsScreen').style.display = 'block';
            document.getElementById('headerSubtitle').textContent = 'API í‚¤ ì„¤ì •';
            // ê¸°ì¡´ í‚¤ í‘œì‹œ (ë§ˆìŠ¤í‚¹)
            document.getElementById('keyGemini').value = localStorage.getItem('ai_key_gemini') || '';
            document.getElementById('keyGroq').value = localStorage.getItem('ai_key_groq') || '';
            document.getElementById('keyOpenrouter').value = localStorage.getItem('ai_key_openrouter') || '';
        }

        function closeSettings() {
            document.getElementById('settingsScreen').style.display = 'none';
            document.getElementById('mainMenu').style.display = 'block';
            document.getElementById('headerSubtitle').textContent = 'ê³µì¸ì¤‘ê°œì‚¬ ì‹œí—˜ ëŒ€ë¹„';
            updateApiKeyStatus();
        }

        function saveApiKeys() {
            const gemini = document.getElementById('keyGemini').value.trim();
            const groq = document.getElementById('keyGroq').value.trim();
            const openrouter = document.getElementById('keyOpenrouter').value.trim();

            if (gemini) localStorage.setItem('ai_key_gemini', gemini);
            else localStorage.removeItem('ai_key_gemini');

            if (groq) localStorage.setItem('ai_key_groq', groq);
            else localStorage.removeItem('ai_key_groq');

            if (openrouter) localStorage.setItem('ai_key_openrouter', openrouter);
            else localStorage.removeItem('ai_key_openrouter');

            alert('API í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            closeSettings();
        }

        function clearApiKeys() {
            if (!confirm('ëª¨ë“  API í‚¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            localStorage.removeItem('ai_key_gemini');
            localStorage.removeItem('ai_key_groq');
            localStorage.removeItem('ai_key_openrouter');
            document.getElementById('keyGemini').value = '';
            document.getElementById('keyGroq').value = '';
            document.getElementById('keyOpenrouter').value = '';
            alert('API í‚¤ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            updateApiKeyStatus();
        }

        function updateApiKeyStatus() {
            const count = [AI_KEYS.gemini, AI_KEYS.groq, AI_KEYS.openrouter].filter(k => k).length;
            const el = document.getElementById('apiKeyStatus');
            if (count > 0) {
                el.textContent = `âœ… ${count}ê°œ í‚¤ ë“±ë¡ë¨`;
                el.style.color = '#4caf50';
            } else {
                el.textContent = 'âš ï¸ API í‚¤ë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”';
                el.style.color = '#f44336';
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìƒíƒœ í‘œì‹œ
        document.addEventListener('DOMContentLoaded', updateApiKeyStatus);

        function startQuiz() {
            const selectedYear = document.getElementById('yearSelect').value;
            const selectedSubject = document.getElementById('subjectSelect').value;
            const questionCount = parseInt(document.getElementById('questionCount').value) || 40;

            // ëª¨ë“œë³„ ë¬¸ì œ DB ì„ íƒ
            let sourceDB;
            if (currentMode === 'past') {
                sourceDB = [...questionDatabase];
            } else if (currentMode === 'mock') {
                sourceDB = [...mockDatabase];
            } else if (currentMode === 'practice') {
                sourceDB = [...practiceDatabase];
            } else {
                // ALL: ëª¨ë“  DB í•©ì¹¨
                sourceDB = [...questionDatabase, ...mockDatabase, ...practiceDatabase];
            }

            let filteredQuestions = sourceDB;
            
            if (selectedYear !== 'all' && selectedYear !== 'random') {
                // ALL ëª¨ë“œ: past_2025, mock_1 ë“± ì ‘ë‘ì‚¬ ì²˜ë¦¬
                if (selectedYear.startsWith('past_')) {
                    const year = selectedYear.replace('past_', '');
                    filteredQuestions = questionDatabase.filter(q => q.year == year);
                } else if (selectedYear.startsWith('mock_')) {
                    const year = selectedYear.replace('mock_', '');
                    filteredQuestions = mockDatabase.filter(q => q.year == year);
                } else if (selectedYear.startsWith('practice_')) {
                    const year = selectedYear.replace('practice_', '');
                    filteredQuestions = practiceDatabase.filter(q => q.year == year);
                } else {
                    filteredQuestions = filteredQuestions.filter(q => q.year == selectedYear);
                }
            }

            if (selectedSubject !== 'all') {
                filteredQuestions = filteredQuestions.filter(q => q.subject === selectedSubject);
            }

            if (selectedYear === 'random') {
                filteredQuestions.sort(() => Math.random() - 0.5);
                filteredQuestions = filteredQuestions.slice(0, questionCount);
            } else {
                filteredQuestions.sort(() => Math.random() - 0.5);
            }

            if (filteredQuestions.length === 0) {
                alert('ì„ íƒí•œ ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            currentQuestions = filteredQuestions;
            currentQuestionIndex = 0;
            userAnswers = new Array(currentQuestions.length).fill(null);
            questionAnswered = new Array(currentQuestions.length).fill(false);
            startTime = Date.now();

            if (selectedYear === 'random') {
                document.getElementById('headerSubtitle').textContent = `ëœë¤ ëª¨ë“œ (${currentQuestions.length}ë¬¸ì œ)`;
            } else if (selectedYear === 'all') {
                document.getElementById('headerSubtitle').textContent = '2020-2025ë…„ í†µí•©';
            } else {
                document.getElementById('headerSubtitle').textContent = `${selectedYear}ë…„ ê¸°ì¶œ`;
            }

            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('questionScreen').style.display = 'block';
            
            startTimer();
            displayQuestion();
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('timer').textContent = 
                    `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }, 1000);
        }

        function displayQuestion() {
            const question = currentQuestions[currentQuestionIndex];
            const isAnswered = questionAnswered[currentQuestionIndex];
            
            document.getElementById('questionNumber').textContent = 
                `ë¬¸ì œ ${currentQuestionIndex + 1}/${currentQuestions.length}`;
            
            document.getElementById('yearBadge').textContent = `${question.year}ë…„`;

            const subjectNames = {
                intro: 'ë¶€ë™ì‚°í•™ê°œë¡ ',
                civil: 'ë¯¼ë²• ë° ë¯¼ì‚¬íŠ¹ë³„ë²•',
                broker: 'ê³µì¸ì¤‘ê°œì‚¬ë²•',
                public: 'ë¶€ë™ì‚°ê³µë²•',
                disclosure: 'ë¶€ë™ì‚°ê³µì‹œë²• ë° ì„¸ë²•'
            };
            document.getElementById('subjectBadge').textContent = subjectNames[question.subject] || question.subject;
            
            // ì´ë¯¸ì§€ ë¡œë“œ
            const imgContainer = document.getElementById('questionImage').parentElement;
            const imgElement = document.getElementById('questionImage');
            
            // ê¸°ì¡´ ì—ëŸ¬ ë©”ì‹œì§€ ì œê±° (ìˆë‹¤ë©´)
            const existingError = imgContainer.querySelector('.image-error');
            if (existingError) {
                existingError.remove();
            }
            
            // ì´ë¯¸ì§€ í‘œì‹œ ë° ì—ëŸ¬ í•¸ë“¤ëŸ¬ ì´ˆê¸°í™”
            imgElement.style.display = 'block';
            imgElement.src = question.image;
            imgElement.onerror = function() {
                // ì´ë¯¸ì§€ ìˆ¨ê¸°ê³  ì—ëŸ¬ ë©”ì‹œì§€ ì¶”ê°€
                imgElement.style.display = 'none';
                const errorDiv = document.createElement('div');
                errorDiv.className = 'image-error';
                errorDiv.innerHTML = `
                    <h3>âš ï¸ ì´ë¯¸ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h3>
                    <p>íŒŒì¼: ${question.image}</p>
                    <p style="font-size: 12px; margin-top: 10px;">ì´ë¯¸ì§€ íŒŒì¼ì„ questions/ í´ë”ì— ì¶”ê°€í•´ì£¼ì„¸ìš”.</p>
                `;
                imgContainer.appendChild(errorDiv);
            };
            
            // ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™”
            const buttons = document.querySelectorAll('.number-btn');
            buttons.forEach((btn, index) => {
                btn.className = 'number-btn';
                
                if (isAnswered) {
                    btn.classList.add('disabled');
                    if (index === question.correct) {
                        btn.classList.add('correct');
                    } else if (index === userAnswers[currentQuestionIndex]) {
                        btn.classList.add('wrong');
                    }
                } else if (userAnswers[currentQuestionIndex] === index) {
                    btn.classList.add('selected');
                }
            });

            // í•´ì„¤ í‘œì‹œ
            const explanationBox = document.getElementById('explanationBox');
            const explanationText = document.getElementById('explanationText');
            
            if (isAnswered) {
                const cached = explanationCache[question.image] || question.explanation;
                explanationText.innerHTML = mdToHtml(cached);
                explanationBox.classList.add('show');

                // ì±„íŒ… íˆìŠ¤í† ë¦¬ ë³µì›
                const chatHistoryEl = document.getElementById('chatHistory');
                chatHistoryEl.innerHTML = '';
                const history = chatHistories[question.image];
                if (history && history.length > 1) {
                    // ì²«ë²ˆì§¸ëŠ” í•´ì„¤(ì´ë¯¸ í‘œì‹œë¨), ë‚˜ë¨¸ì§€ë§Œ ë³µì›
                    for (let i = 1; i < history.length; i++) {
                        const bubble = document.createElement('div');
                        bubble.className = 'chat-bubble ' + (history[i].role === 'user' ? 'user' : 'ai');
                        bubble.innerHTML = history[i].role === "ai" ? mdToHtml(history[i].content) : history[i].content;
                        chatHistoryEl.appendChild(bubble);
                    }
                }

                // followup UI
                if (usedModels[question.image]) {
                    showFollowupUI();
                }
            } else {
                explanationBox.classList.remove('show');
                document.getElementById('chatHistory').innerHTML = '';
                document.getElementById('followupBox').style.display = 'none';
            }

            // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
            const progress = ((currentQuestionIndex + 1) / currentQuestions.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';

            // ë²„íŠ¼ ìƒíƒœ
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            document.getElementById('nextBtn').textContent = 
                currentQuestionIndex === currentQuestions.length - 1 ? 'ê²°ê³¼ ë³´ê¸° âœ“' : 'ë‹¤ìŒ â–¶';
        }

        // ====== AI í•´ì„¤ ì‹œìŠ¤í…œ ======
        const AI_KEYS = {
            get gemini() { return localStorage.getItem('ai_key_gemini') || ''; },
            get groq() { return localStorage.getItem('ai_key_groq') || ''; },
            get openrouter() { return localStorage.getItem('ai_key_openrouter') || ''; }
        };

        function hasAnyApiKey() {
            return AI_KEYS.gemini || AI_KEYS.groq || AI_KEYS.openrouter;
        }

        const explanationCache = {};

        // ëŒ€í™” íˆìŠ¤í† ë¦¬ (ë¬¸ì œë³„)
        const chatHistories = {};
        // í•´ì„¤ ìƒì„±ì— ì„±ê³µí•œ ëª¨ë¸ (ë¬¸ì œë³„)
        const usedModels = {};

        // ë§ˆí¬ë‹¤ìš´ â†’ HTML ë³€í™˜
        function mdToHtml(text) {
            if (!text) return '';

            // 1ë‹¨ê³„: ìˆ˜ì‹ì„ ë¨¼ì € ë³´í˜¸ (placeholderë¡œ ì¹˜í™˜)
            const mathBlocks = [];
            let processed = text;

            if (typeof katex !== 'undefined') {
                // ë¸”ë¡ ìˆ˜ì‹: $$ ... $$
                processed = processed.replace(/\$\$([\s\S]*?)\$\$/g, (_, tex) => {
                    try {
                        const rendered = katex.renderToString(tex.trim(), { displayMode: true, throwOnError: false });
                        mathBlocks.push(rendered);
                        return `%%MATH${mathBlocks.length - 1}%%`;
                    } catch (e) { return tex; }
                });
                // ë¸”ë¡ ìˆ˜ì‹: \[ ... \]
                processed = processed.replace(/\\\[([\s\S]*?)\\\]/g, (_, tex) => {
                    try {
                        const rendered = katex.renderToString(tex.trim(), { displayMode: true, throwOnError: false });
                        mathBlocks.push(rendered);
                        return `%%MATH${mathBlocks.length - 1}%%`;
                    } catch (e) { return tex; }
                });
                // ì¸ë¼ì¸ ìˆ˜ì‹: \( ... \)
                processed = processed.replace(/\\\(([\s\S]*?)\\\)/g, (_, tex) => {
                    try {
                        const rendered = katex.renderToString(tex.trim(), { displayMode: false, throwOnError: false });
                        mathBlocks.push(rendered);
                        return `%%MATH${mathBlocks.length - 1}%%`;
                    } catch (e) { return tex; }
                });
                // ì¸ë¼ì¸ ìˆ˜ì‹: $ ... $ (í•œ ì¤„ ë‚´)
                processed = processed.replace(/(?<!\$)\$(?!\$)([^\$\n]+?)\$(?!\$)/g, (_, tex) => {
                    try {
                        const rendered = katex.renderToString(tex.trim(), { displayMode: false, throwOnError: false });
                        mathBlocks.push(rendered);
                        return `%%MATH${mathBlocks.length - 1}%%`;
                    } catch (e) { return tex; }
                });
            }

            // 2ë‹¨ê³„: HTML ì´ìŠ¤ì¼€ì´í”„ + ë§ˆí¬ë‹¤ìš´ ë³€í™˜
            let html = processed
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/^###\s+(.+)$/gm, '<strong>$1</strong>')
                .replace(/^##\s+(.+)$/gm, '<strong>$1</strong>')
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)/g, '<em>$1</em>')
                .replace(/^\s*[-*]\s+(.+)$/gm, '<li>$1</li>')
                .replace(/^\s*\d+\.\s+(.+)$/gm, '<li>$1</li>')
                .replace(/((<li>.*<\/li>\s*)+)/g, '<ul>$1</ul>')
                .replace(/\n/g, '<br>')
                .replace(/(<br>\s*){2,}/g, '<br>')
                .replace(/<br>\s*<ul>/g, '<ul>')
                .replace(/<\/ul>\s*<br>/g, '</ul>');

            // 3ë‹¨ê³„: ìˆ˜ì‹ placeholder ë³µì›
            html = html.replace(/%%MATH(\d+)%%/g, (_, idx) => mathBlocks[parseInt(idx)]);

            return html;
        }

        // ì´ë¯¸ì§€ â†’ base64
        function imageToBase64(imgEl) {
            const canvas = document.createElement('canvas');
            canvas.width = imgEl.naturalWidth;
            canvas.height = imgEl.naturalHeight;
            canvas.getContext('2d').drawImage(imgEl, 0, 0);
            return canvas.toDataURL('image/jpeg', 0.7).split(',')[1];
        }

        // í•´ì„¤ í”„ë¡¬í”„íŠ¸
        function buildPrompt(ocrText, correctNum) {
            return `ë‹¤ìŒì€ ê³µì¸ì¤‘ê°œì‚¬ ì‹œí—˜ ë¬¸ì œì´ê³ , ì •ë‹µì€ ${correctNum}ë²ˆì´ì•¼.

${ocrText}

ë‹¤ìŒ ê·œì¹™ëŒ€ë¡œ í•´ì„¤ì„ ì‘ì„±í•´:
- 200ì ì´ë‚´ë¡œ ê°„ê²°í•˜ê²Œ (ì‚´ì§ ë„˜ìœ¼ë©´ ë¬¸ì¥ ë§ˆë¬´ë¦¬)
- ì™œ ì •ë‹µì´ ê·¸ê²ƒì¸ì§€, ì£¼ìš” ì˜¤ë‹µì€ ì™œ í‹€ë¦°ì§€ ì„¤ëª…
- ë¬¸ì œ ë‚´ìš©ì„ ê·¸ëŒ€ë¡œ ë°˜ë³µí•˜ì§€ ë§ê¸°
- ëª¨ë“  ë‹¨ì–´ëŠ” í•œêµ­ì–´ë¡œë§Œ ì‘ì„±
- ë°˜ë§ë¡œ ì§§ê³  ê°„ê²°í•˜ê²Œ

í•´ì„¤:`;
        }

        // ë°©ë²•1: Gemini Vision (ì´ë¯¸ì§€ ì§ì ‘ ì „ì†¡ â†’ OCR+í•´ì„¤ í•œë²ˆì—)
        async function tryGeminiVision(base64, correctNum) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${AI_KEYS.gemini}`;
            const prompt = `ì´ ê³µì¸ì¤‘ê°œì‚¬ ì‹œí—˜ ë¬¸ì œ ì´ë¯¸ì§€ë¥¼ ë³´ê³  í•´ì„¤ì„ ì‘ì„±í•´ì¤˜. ì •ë‹µì€ ${correctNum}ë²ˆì´ì•¼.

ê·œì¹™:
- 200ì ì´ë‚´, ë°˜ë§, ê°„ê²°í•˜ê²Œ
- ì™œ ì •ë‹µì´ ê·¸ê²ƒì¸ì§€, ì£¼ìš” ì˜¤ë‹µì€ ì™œ í‹€ë¦°ì§€
- ë¬¸ì œ ë‚´ìš© ë°˜ë³µ ê¸ˆì§€
- í•œêµ­ì–´ë¡œë§Œ ì‘ì„±

í•´ì„¤:`;

            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { inlineData: { mimeType: 'image/jpeg', data: base64 } },
                            { text: prompt }
                        ]
                    }],
                    generationConfig: { maxOutputTokens: 400 }
                })
            });

            if (!res.ok) {
                const errText = await res.text();
                throw new Error(`Gemini Vision ${res.status}: ${errText.substring(0, 100)}`);
            }
            const data = await res.json();
            if (!data.candidates || !data.candidates[0]) throw new Error('Gemini ì‘ë‹µ ì—†ìŒ');
            return data.candidates[0].content.parts[0].text.trim();
        }

        // ë°©ë²•2: Gemini OCRë§Œ (í…ìŠ¤íŠ¸ ì¶”ì¶œìš©)
        async function geminiOCR(base64) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${AI_KEYS.gemini}`;
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { inlineData: { mimeType: 'image/jpeg', data: base64 } },
                            { text: 'ì´ ì‹œí—˜ ë¬¸ì œ ì´ë¯¸ì§€ì˜ í…ìŠ¤íŠ¸ë¥¼ ê·¸ëŒ€ë¡œ ì¶”ì¶œí•´. ë¬¸ì œë²ˆí˜¸, ë³´ê¸°, ì„ íƒì§€ ëª¨ë‘ í¬í•¨. ì„¤ëª… ì—†ì´ í…ìŠ¤íŠ¸ë§Œ.' }
                        ]
                    }],
                    generationConfig: { maxOutputTokens: 800 }
                })
            });
            if (!res.ok) throw new Error(`OCR ì‹¤íŒ¨ ${res.status}`);
            const data = await res.json();
            if (!data.candidates || !data.candidates[0]) throw new Error('OCR ì‘ë‹µ ì—†ìŒ');
            return data.candidates[0].content.parts[0].text.trim();
        }

        // Groq Vision í˜¸ì¶œ (ì´ë¯¸ì§€ ì§ì ‘ ì „ì†¡)
        async function callGroqVision(base64, correctNum) {
            const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${AI_KEYS.groq}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: 'meta-llama/llama-4-scout-17b-16e-instruct',
                    messages: [{
                        role: 'user',
                        content: [
                            {
                                type: 'image_url',
                                image_url: { url: `data:image/jpeg;base64,${base64}` }
                            },
                            {
                                type: 'text',
                                text: `ì´ ê³µì¸ì¤‘ê°œì‚¬ ì‹œí—˜ ë¬¸ì œë¥¼ ë³´ê³  í•´ì„¤ì„ ì‘ì„±í•´ì¤˜. ì •ë‹µì€ ${correctNum}ë²ˆì´ì•¼.

ê·œì¹™:
- 200ì ì´ë‚´, ë°˜ë§, ê°„ê²°í•˜ê²Œ
- ì™œ ì •ë‹µì´ ê·¸ê²ƒì¸ì§€, ì£¼ìš” ì˜¤ë‹µì€ ì™œ í‹€ë¦°ì§€
- ë¬¸ì œ ë‚´ìš© ë°˜ë³µ ê¸ˆì§€
- í•œêµ­ì–´ë¡œë§Œ ì‘ì„±

í•´ì„¤:`
                            }
                        ]
                    }],
                    max_tokens: 400
                })
            });
            if (!res.ok) throw new Error(`Groq Vision ${res.status}`);
            const data = await res.json();
            return data.choices[0].message.content.trim();
        }

        // Groq í…ìŠ¤íŠ¸ í˜¸ì¶œ (OCR í…ìŠ¤íŠ¸ ê¸°ë°˜)
        async function callGroq(prompt) {
            const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${AI_KEYS.groq}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: 'llama-3.1-8b-instant',
                    messages: [{ role: 'user', content: prompt }],
                    max_tokens: 400
                })
            });
            if (!res.ok) throw new Error(`Groq ${res.status}`);
            const data = await res.json();
            return data.choices[0].message.content.trim();
        }

        // OpenRouter í˜¸ì¶œ
        async function callOpenRouter(prompt) {
            const res = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${AI_KEYS.openrouter}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: 'mistralai/mixtral-8x7b-instruct',
                    messages: [{ role: 'user', content: prompt }],
                    max_tokens: 400
                })
            });
            if (!res.ok) throw new Error(`OpenRouter ${res.status}`);
            const data = await res.json();
            return data.choices[0].message.content.trim();
        }

        // Gemini í…ìŠ¤íŠ¸ í•´ì„¤ (OCR í…ìŠ¤íŠ¸ ê¸°ë°˜)
        async function callGeminiText(prompt) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${AI_KEYS.gemini}`;
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { maxOutputTokens: 400 }
                })
            });
            if (!res.ok) throw new Error(`Gemini Text ${res.status}`);
            const data = await res.json();
            if (!data.candidates || !data.candidates[0]) throw new Error('Gemini Text ì‘ë‹µ ì—†ìŒ');
            return data.candidates[0].content.parts[0].text.trim();
        }

        // ë©”ì¸ í•´ì„¤ ìƒì„± (ë©€í‹° ëª¨ë¸ í´ë°±)
        async function getAIExplanation(question) {
            const cacheKey = question.image;
            if (explanationCache[cacheKey]) return explanationCache[cacheKey];

            const img = document.getElementById('questionImage');
            if (!img || !img.complete || !img.naturalWidth) {
                throw new Error('ì´ë¯¸ì§€ ë¡œë“œ ì•ˆë¨');
            }

            const base64 = imageToBase64(img);
            const correctNum = question.correct + 1;
            let ocrText = null;

            // ì„±ê³µ ì‹œ ê³µí†µ ì²˜ë¦¬
            function onSuccess(result, modelName) {
                console.log(`âœ… ${modelName} ì„±ê³µ`);
                usedModels[cacheKey] = modelName;
                chatHistories[cacheKey] = [{ role: 'assistant', content: result }];
                explanationCache[cacheKey] = result;
                question.explanation = result;
            }

            // 1ì°¨: Gemini Vision
            try {
                console.log('1ì°¨: Gemini Vision ì‹œë„...');
                const result = await tryGeminiVision(base64, correctNum);
                if (result && result.length > 10) {
                    onSuccess(result, 'geminiVision');
                    return result;
                }
            } catch (e) {
                console.warn('âŒ Gemini Vision ì‹¤íŒ¨:', e.message);
            }

            // 2ì°¨: Groq Vision
            try {
                console.log('2ì°¨: Groq Vision ì‹œë„...');
                const result = await callGroqVision(base64, correctNum);
                if (result && result.length > 10) {
                    onSuccess(result, 'groqVision');
                    return result;
                }
            } catch (e) {
                console.warn('âŒ Groq Vision ì‹¤íŒ¨:', e.message);
            }

            // 3ì°¨: OCR ì¶”ì¶œ â†’ í…ìŠ¤íŠ¸ ê¸°ë°˜ ëª¨ë¸ë“¤
            try {
                console.log('OCR ì¶”ì¶œ ì‹œë„...');
                ocrText = await geminiOCR(base64);
                console.log('OCR ì„±ê³µ, ê¸¸ì´:', ocrText.length);
            } catch (e) {
                console.warn('âŒ OCR ì‹¤íŒ¨:', e.message);
                ocrText = null;
            }

            if (ocrText && ocrText.length >= 20) {
                const prompt = buildPrompt(ocrText, correctNum);

                // 4ì°¨: Gemini í…ìŠ¤íŠ¸
                try {
                    console.log('4ì°¨: Gemini Text ì‹œë„...');
                    const result = await callGeminiText(prompt);
                    if (result && result.length > 10) {
                        onSuccess(result, 'geminiText');
                        return result;
                    }
                } catch (e) {
                    console.warn('âŒ Gemini Text ì‹¤íŒ¨:', e.message);
                }

                // 5ì°¨: Groq í…ìŠ¤íŠ¸
                try {
                    console.log('5ì°¨: Groq Text ì‹œë„...');
                    const result = await callGroq(prompt);
                    if (result && result.length > 10) {
                        onSuccess(result, 'groqText');
                        return result;
                    }
                } catch (e) {
                    console.warn('âŒ Groq Text ì‹¤íŒ¨:', e.message);
                }

                // 6ì°¨: OpenRouter
                try {
                    console.log('6ì°¨: OpenRouter ì‹œë„...');
                    const result = await callOpenRouter(prompt);
                    if (result && result.length > 10) {
                        onSuccess(result, 'openrouter');
                        return result;
                    }
                } catch (e) {
                    console.warn('âŒ OpenRouter ì‹¤íŒ¨:', e.message);
                }
            }

            throw new Error('ëª¨ë“  ëª¨ë¸ ì‹¤íŒ¨');
        }

        // ì¶”ê°€ ì§ˆë¬¸ ì „ì†¡
        async function sendFollowup() {
            const input = document.getElementById('followupInput');
            const userMsg = input.value.trim();
            if (!userMsg) return;

            const question = currentQuestions[currentQuestionIndex];
            const cacheKey = question.image;
            const modelName = usedModels[cacheKey];
            if (!modelName) return;

            // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
            const chatHistory = document.getElementById('chatHistory');
            const userBubble = document.createElement('div');
            userBubble.className = 'chat-bubble user';
            userBubble.textContent = userMsg;
            chatHistory.appendChild(userBubble);

            // ì…ë ¥ ì´ˆê¸°í™” & ë¹„í™œì„±í™”
            input.value = '';
            input.disabled = true;
            document.querySelector('.followup-btn').disabled = true;

            // ë¡œë”© í‘œì‹œ
            const loadingBubble = document.createElement('div');
            loadingBubble.className = 'chat-bubble ai';
            loadingBubble.innerHTML = '<div class="explanation-loading"><div class="spinner"></div>ë‹µë³€ ìƒì„± ì¤‘...</div>';
            chatHistory.appendChild(loadingBubble);

            // íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
            if (!chatHistories[cacheKey]) chatHistories[cacheKey] = [];
            chatHistories[cacheKey].push({ role: 'user', content: userMsg });

            try {
                let aiReply;
                const history = chatHistories[cacheKey];
                const base64 = imageToBase64(document.getElementById('questionImage'));

                if (modelName === 'geminiVision' || modelName === 'geminiText') {
                    // Gemini: ëŒ€í™” íˆìŠ¤í† ë¦¬ í¬í•¨ í˜¸ì¶œ
                    const contents = [];
                    // ì²« ë©”ì‹œì§€ì— ì´ë¯¸ì§€ í¬í•¨
                    contents.push({
                        role: 'user',
                        parts: [
                            { inlineData: { mimeType: 'image/jpeg', data: base64 } },
                            { text: 'ì´ ê³µì¸ì¤‘ê°œì‚¬ ì‹œí—˜ ë¬¸ì œì— ëŒ€í•´ ì§ˆë¬¸í• ê²Œ.' }
                        ]
                    });
                    history.forEach(msg => {
                        contents.push({
                            role: msg.role === 'assistant' ? 'model' : 'user',
                            parts: [{ text: msg.content }]
                        });
                    });

                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${AI_KEYS.gemini}`;
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents, generationConfig: { maxOutputTokens: 500 } })
                    });
                    if (!res.ok) throw new Error(`Gemini ${res.status}`);
                    const data = await res.json();
                    aiReply = data.candidates[0].content.parts[0].text.trim();

                } else if (modelName === 'groqVision' || modelName === 'groqText') {
                    // Groq: ëŒ€í™” íˆìŠ¤í† ë¦¬ í¬í•¨ í˜¸ì¶œ
                    const messages = [];
                    // ì²« ë©”ì‹œì§€ì— ì´ë¯¸ì§€ í¬í•¨
                    messages.push({
                        role: 'user',
                        content: [
                            { type: 'image_url', image_url: { url: `data:image/jpeg;base64,${base64}` } },
                            { type: 'text', text: 'ì´ ê³µì¸ì¤‘ê°œì‚¬ ì‹œí—˜ ë¬¸ì œì— ëŒ€í•´ ì§ˆë¬¸í• ê²Œ.' }
                        ]
                    });
                    history.forEach(msg => {
                        messages.push({ role: msg.role, content: msg.content });
                    });

                    const model = modelName === 'groqVision' ? 'meta-llama/llama-4-scout-17b-16e-instruct' : 'llama-3.1-8b-instant';
                    const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${AI_KEYS.groq}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ model, messages, max_tokens: 500 })
                    });
                    if (!res.ok) throw new Error(`Groq ${res.status}`);
                    const data = await res.json();
                    aiReply = data.choices[0].message.content.trim();

                } else {
                    // OpenRouter
                    const messages = [];
                    history.forEach(msg => {
                        messages.push({ role: msg.role, content: msg.content });
                    });

                    const res = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${AI_KEYS.openrouter}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: 'mistralai/mixtral-8x7b-instruct',
                            messages,
                            max_tokens: 500
                        })
                    });
                    if (!res.ok) throw new Error(`OpenRouter ${res.status}`);
                    const data = await res.json();
                    aiReply = data.choices[0].message.content.trim();
                }

                // ì‘ë‹µ í‘œì‹œ
                loadingBubble.innerHTML = '';
                loadingBubble.innerHTML = mdToHtml(aiReply);
                chatHistories[cacheKey].push({ role: 'assistant', content: aiReply });

            } catch (e) {
                console.error('ì¶”ê°€ ì§ˆë¬¸ ì‹¤íŒ¨:', e);
                loadingBubble.innerHTML = '<span style="color:#f44336;">ë‹µë³€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</span>';
            }

            // ì…ë ¥ ë‹¤ì‹œ í™œì„±í™”
            input.disabled = false;
            document.querySelector('.followup-btn').disabled = false;
            input.focus();

            // ìŠ¤í¬ë¡¤
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // ì¶”ê°€ ì§ˆë¬¸ UI í‘œì‹œ
        function showFollowupUI() {
            document.getElementById('followupBox').style.display = 'block';
            // Enter í‚¤ë¡œ ì „ì†¡
            const input = document.getElementById('followupInput');
            input.onkeydown = (e) => {
                if (e.key === 'Enter') sendFollowup();
            };
        }

        // retry í•¸ë“¤ëŸ¬
        function retryExplanation() {
            const question = currentQuestions[currentQuestionIndex];
            const explanationText = document.getElementById('explanationText');
            explanationText.innerHTML = '<div class="explanation-loading"><div class="spinner"></div>AI í•´ì„¤ ì¬ì‹œë„ ì¤‘...</div>';

            getAIExplanation(question).then((text) => {
                explanationText.innerHTML = mdToHtml(text);
                showFollowupUI();
            }).catch((err) => {
                console.error('AI í•´ì„¤ ì¬ì‹œë„ ì‹¤íŒ¨:', err);
                explanationText.innerHTML = '<span style="color:#f44336;">í•´ì„¤ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</span><br><button class="retry-btn" onclick="retryExplanation()">ğŸ”„ ë‹¤ì‹œ ì‹œë„</button>';
            });
        }

        function selectAnswer(answerIndex) {
            if (questionAnswered[currentQuestionIndex]) {
                return;
            }

            const question = currentQuestions[currentQuestionIndex];
            userAnswers[currentQuestionIndex] = answerIndex;
            questionAnswered[currentQuestionIndex] = true;

            // ì¦‰ì‹œ ì •ë‹µ/ì˜¤ë‹µ í‘œì‹œ
            const buttons = document.querySelectorAll('.number-btn');
            buttons.forEach((btn, index) => {
                btn.classList.add('disabled');
                if (index === question.correct) {
                    btn.classList.add('correct');
                } else if (index === answerIndex) {
                    btn.classList.add('wrong');
                }
            });

            // í•´ì„¤ í‘œì‹œ
            const explanationBox = document.getElementById('explanationBox');
            const explanationText = document.getElementById('explanationText');
            explanationBox.classList.add('show');

            // ê¸°ì¡´ í•´ì„¤ì´ ìˆìœ¼ë©´ ë°”ë¡œ í‘œì‹œ, ì—†ìœ¼ë©´ AI ìƒì„±
            if (question.explanation && question.explanation.trim() !== '') {
                explanationText.innerHTML = mdToHtml(question.explanation);
                showFollowupUI();
            } else {
                explanationText.innerHTML = '<div class="explanation-loading"><div class="spinner"></div>AI í•´ì„¤ ìƒì„± ì¤‘...</div>';

                getAIExplanation(question).then((text) => {
                    explanationText.innerHTML = mdToHtml(text);
                    showFollowupUI();
                }).catch((err) => {
                    console.error('AI í•´ì„¤ ì‹¤íŒ¨:', err);
                    explanationText.innerHTML = '<span style="color:#f44336;">í•´ì„¤ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</span><br><button class="retry-btn" onclick="retryExplanation()">ğŸ”„ ë‹¤ì‹œ ì‹œë„</button>';
                });
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion();
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < currentQuestions.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            } else {
                showResults();
            }
        }

        function goHome() {
            if (confirm('ì •ë§ í™ˆìœ¼ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?\ní˜„ì¬ê¹Œì§€ì˜ ì§„í–‰ ìƒí™©ì€ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.')) {
                clearInterval(timerInterval);
                resetQuiz();
            }
        }

        function finishEarly() {
            if (confirm('ì‹œí—˜ì„ ì¢…ë£Œí•˜ê³  ê²°ê³¼ë¥¼ í™•ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në‹µí•˜ì§€ ì•Šì€ ë¬¸ì œëŠ” ì˜¤ë‹µìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.')) {
                for (let i = 0; i < currentQuestions.length; i++) {
                    if (userAnswers[i] === null) {
                        userAnswers[i] = -1;
                    }
                }
                showResults();
            }
        }

        function showResults() {
            clearInterval(timerInterval);

            let correctCount = 0;
            let wrongQuestions = [];

            userAnswers.forEach((answer, index) => {
                if (answer === currentQuestions[index].correct) {
                    correctCount++;
                } else {
                    wrongQuestions.push({
                        questionNum: index + 1,
                        question: currentQuestions[index],
                        userAnswer: answer
                    });
                }
            });

            const score = Math.round((correctCount / currentQuestions.length) * 100);

            document.getElementById('questionScreen').style.display = 'none';
            document.getElementById('resultScreen').style.display = 'block';

            document.getElementById('finalScore').textContent = score + 'ì ';
            document.getElementById('totalQuestions').textContent = currentQuestions.length;
            document.getElementById('correctAnswers').textContent = correctCount;
            document.getElementById('wrongAnswers').textContent = wrongQuestions.length;

            const wrongAnswersList = document.getElementById('wrongAnswersList');
            wrongAnswersList.innerHTML = '';

            if (wrongQuestions.length === 0) {
                wrongAnswersList.innerHTML = '<p style="text-align: center; color: #4caf50; font-size: 18px; padding: 40px;">ğŸ‰ ëª¨ë“  ë¬¸ì œë¥¼ ë§í˜”ìŠµë‹ˆë‹¤! ì™„ë²½í•©ë‹ˆë‹¤!</p>';
            } else {
                wrongQuestions.forEach(wrong => {
                    const wrongDiv = document.createElement('div');
                    wrongDiv.className = 'wrong-answer-item';
                    
                    const userAnswerText = wrong.userAnswer !== null && wrong.userAnswer !== -1
                        ? `${wrong.userAnswer + 1}ë²ˆ` 
                        : '(ë‹µì•ˆ ë¯¸ì„ íƒ)';
                    
                    wrongDiv.innerHTML = `
                        <div class="wrong-answer-header">
                            [${wrong.question.year}ë…„] ë¬¸ì œ ${wrong.questionNum}
                        </div>
                        <div style="margin-top: 10px;">
                            <div style="color: #f44336; margin-bottom: 5px;">
                                âŒ ì„ íƒí•œ ë‹µ: ${userAnswerText}
                            </div>
                            <div style="color: #4caf50; margin-bottom: 5px;">
                                âœ… ì •ë‹µ: ${wrong.question.correct + 1}ë²ˆ
                            </div>
                        </div>
                        <div class="wrong-answer-explanation">
                            <div class="explanation-label">ğŸ’¡ í•´ì„¤:</div>
                            ${explanationCache[wrong.question.image] || wrong.question.explanation || 'í•´ì„¤ ì—†ìŒ'}
                        </div>
                    `;
                    wrongAnswersList.appendChild(wrongDiv);
                });
            }
        }

        function resetQuiz() {
            currentQuestionIndex = 0;
            userAnswers = [];
            questionAnswered = [];
            document.getElementById('questionScreen').style.display = 'none';
            document.getElementById('resultScreen').style.display = 'none';
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('settingsScreen').style.display = 'none';
            document.getElementById('mainMenu').style.display = 'block';
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('headerSubtitle').textContent = 'ê³µì¸ì¤‘ê°œì‚¬ ì‹œí—˜ ëŒ€ë¹„';
            updateApiKeyStatus();
        }

        function restartQuiz() {
            resetQuiz();
        }
    </script>
</body>
</html>